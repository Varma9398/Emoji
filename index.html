<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script defer src="/_vercel/insights/script.js"></script>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G69D08BCFE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-G69D08BCFE');
</script>
<title>Moodies ‚Äî Advanced Emoji Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto&family=Lato&family=Open+Sans&family=Montserrat&family=Raleway&family=Oswald&family=Merriweather&family=Poppins&family=Ubuntu&family=Playfair+Display&family=Rubik&family=Nunito&family=Source+Sans+Pro&family=PT+Sans&family=Quicksand&family=Cabin&family=Dancing+Script&family=Lobster&family=Shadows+Into+Light&family=Indie+Flower&family=Caveat&family=Satisfy&family=Permanent+Marker&family=Architects+Daughter&family=Sacramento&family=Amatic+SC&family=Fredoka+One&family=Comfortaa&family=Righteous&family=Courgette&family=Kaushan+Script&family=Paytone+One&family=Abril+Fatface&family=Russo+One&family=Bree+Serif&family=Passion+One&family=Acme&family=Exo&family=Bitter&family=Fjalla+One&family=Yanone+Kaffeesatz&family=Bebas+Neue&family=Varela+Round&family=Crimson+Text&family=Teko&family=Josefin+Sans&family=Cormorant+Garamond&family=Barlow&family=Fira+Sans&family=Mukta&family=Work+Sans&family=Arvo&family=Hind&family=Noto+Sans&family=Noto+Serif&family=Libre+Baskerville&family=Karla&family=Inconsolata&family=Alegreya&family=Alegreya+Sans&family=Signika&family=Vollkorn&family=Asap&family=Overpass&family=Prompt&family=Crete+Round&family=Patua+One&family=Spectral&family=IBM+Plex+Sans&family=IBM+Plex+Serif&family=Domine&family=Barlow+Condensed&family=Archivo&family=Archivo+Narrow&family=Manrope&family=DM+Sans&family=DM+Serif+Display&family=Literata&family=Mulish&family=Sora&family=Fraunces&family=Epilogue&family=Outfit&family=Urbanist&family=Lexend&family=Plus+Jakarta+Sans&family=Figtree&family=Instrument+Sans&family=Gabarito&family=Noto+Sans+Display&display=swap" rel="stylesheet">
<style>
:root{
  --accent:#ff9a62;
  --bg:#ffffff;
  --muted:#666;
  --card:#f7f7f8;
  --border:#e6e6e6;
  --shadow:0 4px 20px rgba(0,0,0,0.08);
  
  /* Theme variables */
  --body-bg: #ffffff;
  --panel-bg: #f7f7f8;
  --panel-border: #e6e6e6;
  --input-bg: #ffffff;
  --input-border: #e6e6e6;
  --input-text: #333333;
  --btn-bg: #f7f7f8;
  --btn-border: #e6e6e6;
  --btn-text: #333333;
  --canvas-border: #e6e6e6;
}

/* Dark theme variables removed */
  --btn-border: #555;
  --btn-text: #f0f0f0;
  --canvas-border: #444;
}

/* Theme toggle button removed */

/* Zoom controls styling */
/* Zoom and pan controls CSS removed */

/* Modal styling */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: white;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid var(--border);
  border-radius: 8px;
  width: 80%;
  max-width: 400px;
  box-shadow: var(--shadow);
}

.close-button {
  color: var(--muted);
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close-button:hover {
  color: black;
}

.modal h3 {
  margin-top: 0;
  margin-bottom: 20px;
  color: var(--accent);
}

* { box-sizing: border-box; }

body {
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  margin: 0;
  background: var(--bg);
  color: #000;
  line-height: 1.5;
}

/* Header */
.header {
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
  background: white;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.brand {
  display: flex;
  gap: 12px;
  align-items: center;
}

.logo {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--accent), #ff8a3a);
  display: grid;
  place-items: center;
  color: white;
  font-weight: 700;
  font-size: 16px;
  box-shadow: 0 4px 12px rgba(255,154,98,0.2);
}

.brand-info h1 {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
}

.brand-info p {
  margin: 0;
  font-size: 12px;
  color: var(--muted);
}

.header-nav {
  display: flex;
  gap: 8px;
  align-items: center;
}

.btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn:hover {
  background: #f8f9fa;
  transform: translateY(-1px);
}

.btn-accent {
  background: var(--accent);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(255,154,98,0.2);
}

.btn-accent:hover {
  background: #ff8a3a;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255,154,98,0.3);
}

/* Main Layout */
.main-container {
  display: grid;
  grid-template-columns: 280px 1fr 320px;
  height: calc(100vh - 81px);
  gap: 1px;
  background: var(--border);
}

/* Navigation Panel */
.nav-panel {
  background: white;
  padding: 20px;
  overflow-y: auto;
  border-right: 1px solid var(--border);
}

.nav-section {
  margin-bottom: 24px;
}

.nav-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.upload-btn {
  padding: 4px 8px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 10px;
  cursor: pointer;
  font-weight: 500;
}

.upload-btn:hover {
  background: #ff8a3a;
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-bottom: 16px;
}

.emoji-item {
  aspect-ratio: 1;
  border: 2px solid transparent;
  border-radius: 8px;
  background: #f8f9fa;
  cursor: pointer;
  display: grid;
  place-items: center;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}

.emoji-item:hover {
  border-color: var(--accent);
  transform: scale(1.05);
  box-shadow: var(--shadow);
}

.emoji-item.active {
  border-color: var(--accent);
  background: #fff4f0;
}

.emoji-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
}

.emoji-placeholder {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #ddd, #ccc);
  border-radius: 6px;
  display: grid;
  place-items: center;
  color: #888;
  font-size: 10px;
  font-weight: 600;
}

.emoji-item .delete-btn {
  position: absolute;
  top: 2px;
  right: 2px;
  width: 16px;
  height: 16px;
  background: rgba(255,0,0,0.8);
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 10px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s ease;
  display: grid;
  place-items: center;
}

.emoji-item:hover .delete-btn {
  opacity: 1;
}

.pagination {
  display: flex;
  justify-content: center;
  gap: 4px;
  margin-top: 12px;
}

.page-btn {
  width: 32px;
  height: 32px;
  border: 1px solid var(--border);
  background: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.page-btn:hover, .page-btn.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

/* File Upload Area */
.upload-area {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  margin-bottom: 16px;
  transition: all 0.2s ease;
  cursor: pointer;
}

.upload-area:hover, .upload-area.dragover {
  border-color: var(--accent);
  background: #fff4f0;
}

.upload-area.dragover {
  border-style: solid;
}

.upload-text {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 8px;
}

.file-input {
  display: none;
}

/* Canvas Area */
.canvas-area {
  background: white;
  padding: 24px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.canvas-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.canvas-title {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
}

.canvas-actions {
  display: flex;
  gap: 8px;
}

.canvas-container {
  flex: 1;
  border: 2px dashed var(--border);
  border-radius: 12px;
  background: #fafafa;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  min-height: 400px;
  margin-top: 10px;
}

.canvas {
  width: 512px;
  height: 512px;
  position: relative;
  background: var(--body-bg);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: var(--shadow);
  margin: auto;
  border: 1px solid var(--canvas-border);
  transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
}

.canvas-placeholder {
  color: var(--muted);
  text-align: center;
  font-size: 14px;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

/* Text Overlay */
.text-overlay {
  position: absolute;
  cursor: move;
  user-select: none;
  touch-action: none;
  z-index: 10;
  border: 2px solid transparent;
  border-radius: 4px;
  padding: 4px;
  transition: border-color 0.2s ease;
  outline: none;
  min-width: 20px;
  min-height: 20px;
  word-wrap: break-word;
}

/* Front/back positioning CSS removed */

.text-overlay:hover, .text-overlay.selected {
  border-color: var(--accent);
}

.text-overlay.dragging {
  z-index: 20;
}

.text-overlay[contenteditable="true"]:focus {
  border-color: #4CAF50;
}

.resize-handle {
  position: absolute;
  bottom: -4px;
  right: -4px;
  width: 8px;
  height: 8px;
  background: var(--accent);
  border-radius: 50%;
  cursor: se-resize;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.text-overlay:hover .resize-handle,
.text-overlay.selected .resize-handle {
  opacity: 1;
}

.delete-handle {
  position: absolute;
  top: -4px;
  right: -4px;
  width: 16px;
  height: 16px;
  background: #ff4444;
  color: white;
  border-radius: 50%;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s ease;
  display: grid;
  place-items: center;
  font-size: 10px;
  font-weight: bold;
}

.text-overlay:hover .delete-handle,
.text-overlay.selected .delete-handle {
  opacity: 1;
}

/* Background Image */
.canvas-bg-image {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 1;
}

/* Multiple Images */
.canvas-image {
  position: absolute;
  cursor: move;
  user-select: none;
  touch-action: none;
  border: 2px solid transparent;
  transition: border-color 0.2s ease;
}

.canvas-image:hover, .canvas-image.selected {
  border-color: var(--accent);
}

.canvas-image.dragging {
  z-index: 20;
}

.canvas-image .resize-handle {
  position: absolute;
  bottom: -4px;
  right: -4px;
  width: 8px;
  height: 8px;
  background: var(--accent);
  border-radius: 50%;
  cursor: se-resize;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.canvas-image:hover .resize-handle,
.canvas-image.selected .resize-handle {
  opacity: 1;
}

.canvas-image .delete-handle {
  position: absolute;
  top: -4px;
  right: -4px;
  width: 16px;
  height: 16px;
  background: #ff4444;
  color: white;
  border-radius: 50%;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s ease;
  display: grid;
  place-items: center;
  font-size: 10px;
  font-weight: bold;
}

/* Tools Panel */
.tools-panel {
  background: white;
  padding: 20px;
  overflow-y: auto;
  border-left: 1px solid var(--border);
}

.tool-section {
  margin-bottom: 24px;
}

.tool-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: #333;
}

.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
  margin-bottom: 6px;
}

.form-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.2s ease;
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
}

.form-textarea {
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
}

.form-select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  background: white;
  cursor: pointer;
}

.form-range {
  width: 100%;
  margin: 8px 0;
}

.color-input {
  width: 100%;
  height: 40px;
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  padding: 2px;
}

.font-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  max-height: 300px;
  overflow-y: auto;
  padding-right: 8px;
}

.font-item {
  padding: 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  text-align: center;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s ease;
}

.font-item:hover, .font-item.active {
  border-color: var(--accent);
  background: #fff4f0;
}

.export-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

/* Status Messages */
.status-message {
  position: fixed;
  top: 100px;
  right: 20px;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  z-index: 1000;
  opacity: 0;
  transform: translateY(-20px);
  transition: all 0.3s ease;
}

.status-message.show {
  opacity: 1;
  transform: translateY(0);
}

.status-message.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.status-message.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

/* Responsive */
@media (max-width: 1200px) {
  .main-container {
    grid-template-columns: 240px 1fr 280px;
  }
}

@media (max-width: 968px) {
  .main-container {
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr auto;
    height: auto;
    min-height: calc(100vh - 81px);
  }
  
  .nav-panel, .tools-panel {
    position: static;
    height: auto;
  }
  
  .emoji-grid {
    grid-template-columns: repeat(6, 1fr);
  }
  
  .canvas {
    width: 100%;
    height: 400px;
  }
  
  .canvas-area {
    min-height: 400px;
  }
}

/* Scrollbar Styling */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: #999;
}

/* Loading Animation */
.loading {
  display: inline-block;
  width: 12px;
  height: 12px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body>
  <!-- Theme toggle removed -->

<header class="header">
  <div class="brand">
    <div class="logo">M</div>
    <div class="brand-info">
      <h1>Moodies</h1>
      <p>Advanced Emoji Editor</p>
    </div>
  </div>
  <nav class="header-nav">
    <button class="btn" onclick="clearCanvas()">üóëÔ∏è Clear</button>
    <button class="btn" onclick="undoAction()">‚Ü∂ Undo</button>
    <button class="btn btn-accent" onclick="exportPNG()">üíæ Export PNG</button>
  </nav>
</header>

<main class="main-container">
  <!-- Navigation Panel -->
  <aside class="nav-panel">
    <div class="nav-section">
      <div class="nav-title">Emoji Library (<span id="emojiCount">0</span>)</div>
      <div id="emojiGrid" class="emoji-grid">
        <!-- Emoji items will be populated here -->
      </div>
      <div class="pagination" id="pagination">
        <!-- Pagination buttons will be populated here -->
      </div>
    </div>
  </aside>

  <!-- Canvas Area -->
  <section class="canvas-area">
    <div class="canvas-header">
      <h2 class="canvas-title">Design Canvas</h2>
      <div class="canvas-actions">
        <button class="btn" onclick="addTextLayer()">üìù Add Text</button>
        <button class="btn" onclick="toggleGrid()">‚äû Grid</button>
      </div>
    </div>
    
    <!-- Zoom and Pan Controls have been removed -->
    
    <!-- Canvas container without zoom controls inside -->
    <div class="canvas-container" id="canvasContainer">
      <div id="canvas" class="canvas">
        <div class="canvas-placeholder" id="canvasPlaceholder">
          Upload and select an image from the library to start designing
        </div>
      </div>
    </div>
  </section>

  <!-- Tools Panel -->
  <aside class="tools-panel">
    <div class="tool-section">
      <div class="tool-title">Text Properties</div>
      
      <div class="form-group">
        <label class="form-label">Text Content</label>
        <textarea class="form-input form-textarea" id="textContent" placeholder="Enter your text here..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Font Family</label>
        <div class="font-grid" id="fontGrid">
          <!-- System Fonts -->
          <div class="font-item active" data-font="Arial" style="font-family: Arial;">Arial</div>
          <div class="font-item" data-font="Georgia" style="font-family: Georgia;">Georgia</div>
          <div class="font-item" data-font="'Times New Roman'" style="font-family: 'Times New Roman';">Times</div>
          <div class="font-item" data-font="'Courier New'" style="font-family: 'Courier New';">Courier</div>
          <div class="font-item" data-font="Helvetica" style="font-family: Helvetica;">Helvetica</div>
          <div class="font-item" data-font="Impact" style="font-family: Impact;">Impact</div>
          <div class="font-item" data-font="'Comic Sans MS'" style="font-family: 'Comic Sans MS';">Comic</div>
          
          <!-- Google Fonts -->
          <div class="font-item" data-font="'Pacifico', cursive" style="font-family: 'Pacifico', cursive;">Pacifico</div>
          <div class="font-item" data-font="'Roboto', sans-serif" style="font-family: 'Roboto', sans-serif;">Roboto</div>
          <div class="font-item" data-font="'Lato', sans-serif" style="font-family: 'Lato', sans-serif;">Lato</div>
          <div class="font-item" data-font="'Open Sans', sans-serif" style="font-family: 'Open Sans', sans-serif;">Open Sans</div>
          <div class="font-item" data-font="'Montserrat', sans-serif" style="font-family: 'Montserrat', sans-serif;">Montserrat</div>
          <div class="font-item" data-font="'Raleway', sans-serif" style="font-family: 'Raleway', sans-serif;">Raleway</div>
          <div class="font-item" data-font="'Oswald', sans-serif" style="font-family: 'Oswald', sans-serif;">Oswald</div>
          <div class="font-item" data-font="'Merriweather', serif" style="font-family: 'Merriweather', serif;">Merriweather</div>
          <div class="font-item" data-font="'Poppins', sans-serif" style="font-family: 'Poppins', sans-serif;">Poppins</div>
          <div class="font-item" data-font="'Ubuntu', sans-serif" style="font-family: 'Ubuntu', sans-serif;">Ubuntu</div>
          <div class="font-item" data-font="'Playfair Display', serif" style="font-family: 'Playfair Display', serif;">Playfair</div>
          <div class="font-item" data-font="'Rubik', sans-serif" style="font-family: 'Rubik', sans-serif;">Rubik</div>
          <div class="font-item" data-font="'Nunito', sans-serif" style="font-family: 'Nunito', sans-serif;">Nunito</div>
          <div class="font-item" data-font="'Source Sans Pro', sans-serif" style="font-family: 'Source Sans Pro', sans-serif;">Source Sans</div>
          <div class="font-item" data-font="'PT Sans', sans-serif" style="font-family: 'PT Sans', sans-serif;">PT Sans</div>
          <div class="font-item" data-font="'Quicksand', sans-serif" style="font-family: 'Quicksand', sans-serif;">Quicksand</div>
          <div class="font-item" data-font="'Cabin', sans-serif" style="font-family: 'Cabin', sans-serif;">Cabin</div>
          <div class="font-item" data-font="'Dancing Script', cursive" style="font-family: 'Dancing Script', cursive;">Dancing</div>
          <div class="font-item" data-font="'Lobster', cursive" style="font-family: 'Lobster', cursive;">Lobster</div>
          <div class="font-item" data-font="'Shadows Into Light', cursive" style="font-family: 'Shadows Into Light', cursive;">Shadows</div>
          <div class="font-item" data-font="'Indie Flower', cursive" style="font-family: 'Indie Flower', cursive;">Indie</div>
          <div class="font-item" data-font="'Caveat', cursive" style="font-family: 'Caveat', cursive;">Caveat</div>
          <div class="font-item" data-font="'Satisfy', cursive" style="font-family: 'Satisfy', cursive;">Satisfy</div>
          <div class="font-item" data-font="'Permanent Marker', cursive" style="font-family: 'Permanent Marker', cursive;">Marker</div>
          <div class="font-item" data-font="'Architects Daughter', cursive" style="font-family: 'Architects Daughter', cursive;">Architect</div>
          <div class="font-item" data-font="'Sacramento', cursive" style="font-family: 'Sacramento', cursive;">Sacramento</div>
          <div class="font-item" data-font="'Amatic SC', cursive" style="font-family: 'Amatic SC', cursive;">Amatic</div>
          <div class="font-item" data-font="'Fredoka One', cursive" style="font-family: 'Fredoka One', cursive;">Fredoka</div>
          <div class="font-item" data-font="'Comfortaa', cursive" style="font-family: 'Comfortaa', cursive;">Comfortaa</div>
          <div class="font-item" data-font="'Righteous', cursive" style="font-family: 'Righteous', cursive;">Righteous</div>
          <div class="font-item" data-font="'Courgette', cursive" style="font-family: 'Courgette', cursive;">Courgette</div>
          <div class="font-item" data-font="'Kaushan Script', cursive" style="font-family: 'Kaushan Script', cursive;">Kaushan</div>
          <div class="font-item" data-font="'Paytone One', sans-serif" style="font-family: 'Paytone One', sans-serif;">Paytone</div>
          <div class="font-item" data-font="'Abril Fatface', cursive" style="font-family: 'Abril Fatface', cursive;">Abril</div>
          <div class="font-item" data-font="'Russo One', sans-serif" style="font-family: 'Russo One', sans-serif;">Russo</div>
          <div class="font-item" data-font="'Bree Serif', serif" style="font-family: 'Bree Serif', serif;">Bree</div>
          <div class="font-item" data-font="'Passion One', cursive" style="font-family: 'Passion One', cursive;">Passion</div>
          <div class="font-item" data-font="'Acme', sans-serif" style="font-family: 'Acme', sans-serif;">Acme</div>
          <div class="font-item" data-font="'Exo', sans-serif" style="font-family: 'Exo', sans-serif;">Exo</div>
          <div class="font-item" data-font="'Bitter', serif" style="font-family: 'Bitter', serif;">Bitter</div>
          <div class="font-item" data-font="'Fjalla One', sans-serif" style="font-family: 'Fjalla One', sans-serif;">Fjalla</div>
          <div class="font-item" data-font="'Yanone Kaffeesatz', sans-serif" style="font-family: 'Yanone Kaffeesatz', sans-serif;">Yanone</div>
          <div class="font-item" data-font="'Bebas Neue', cursive" style="font-family: 'Bebas Neue', cursive;">Bebas</div>
          <div class="font-item" data-font="'Varela Round', sans-serif" style="font-family: 'Varela Round', sans-serif;">Varela</div>
          <div class="font-item" data-font="'Crimson Text', serif" style="font-family: 'Crimson Text', serif;">Crimson</div>
          <div class="font-item" data-font="'Teko', sans-serif" style="font-family: 'Teko', sans-serif;">Teko</div>
          <div class="font-item" data-font="'Josefin Sans', sans-serif" style="font-family: 'Josefin Sans', sans-serif;">Josefin</div>
          <div class="font-item" data-font="'Cormorant Garamond', serif" style="font-family: 'Cormorant Garamond', serif;">Cormorant</div>
          <div class="font-item" data-font="'Barlow', sans-serif" style="font-family: 'Barlow', sans-serif;">Barlow</div>
          <div class="font-item" data-font="'Fira Sans', sans-serif" style="font-family: 'Fira Sans', sans-serif;">Fira Sans</div>
          <div class="font-item" data-font="'Mukta', sans-serif" style="font-family: 'Mukta', sans-serif;">Mukta</div>
          <div class="font-item" data-font="'Work Sans', sans-serif" style="font-family: 'Work Sans', sans-serif;">Work Sans</div>
          <div class="font-item" data-font="'Arvo', serif" style="font-family: 'Arvo', serif;">Arvo</div>
          <div class="font-item" data-font="'Hind', sans-serif" style="font-family: 'Hind', sans-serif;">Hind</div>
          <div class="font-item" data-font="'Noto Sans', sans-serif" style="font-family: 'Noto Sans', sans-serif;">Noto Sans</div>
          <div class="font-item" data-font="'Noto Serif', serif" style="font-family: 'Noto Serif', serif;">Noto Serif</div>
          <div class="font-item" data-font="'Libre Baskerville', serif" style="font-family: 'Libre Baskerville', serif;">Libre</div>
          <div class="font-item" data-font="'Karla', sans-serif" style="font-family: 'Karla', sans-serif;">Karla</div>
          <div class="font-item" data-font="'Inconsolata', monospace" style="font-family: 'Inconsolata', monospace;">Inconsolata</div>
          <div class="font-item" data-font="'Alegreya', serif" style="font-family: 'Alegreya', serif;">Alegreya</div>
          <div class="font-item" data-font="'Alegreya Sans', sans-serif" style="font-family: 'Alegreya Sans', sans-serif;">Alegreya Sans</div>
          <div class="font-item" data-font="'Signika', sans-serif" style="font-family: 'Signika', sans-serif;">Signika</div>
          <div class="font-item" data-font="'Vollkorn', serif" style="font-family: 'Vollkorn', serif;">Vollkorn</div>
          <div class="font-item" data-font="'Asap', sans-serif" style="font-family: 'Asap', sans-serif;">Asap</div>
          <div class="font-item" data-font="'Overpass', sans-serif" style="font-family: 'Overpass', sans-serif;">Overpass</div>
          <div class="font-item" data-font="'Prompt', sans-serif" style="font-family: 'Prompt', sans-serif;">Prompt</div>
          <div class="font-item" data-font="'Crete Round', serif" style="font-family: 'Crete Round', serif;">Crete Round</div>
          <div class="font-item" data-font="'Patua One', cursive" style="font-family: 'Patua One', cursive;">Patua One</div>
          <div class="font-item" data-font="'Spectral', serif" style="font-family: 'Spectral', serif;">Spectral</div>
          <div class="font-item" data-font="'IBM Plex Sans', sans-serif" style="font-family: 'IBM Plex Sans', sans-serif;">IBM Plex Sans</div>
          <div class="font-item" data-font="'IBM Plex Serif', serif" style="font-family: 'IBM Plex Serif', serif;">IBM Plex Serif</div>
          <div class="font-item" data-font="'Domine', serif" style="font-family: 'Domine', serif;">Domine</div>
          <div class="font-item" data-font="'Barlow Condensed', sans-serif" style="font-family: 'Barlow Condensed', sans-serif;">Barlow Condensed</div>
          <div class="font-item" data-font="'Archivo', sans-serif" style="font-family: 'Archivo', sans-serif;">Archivo</div>
          <div class="font-item" data-font="'Archivo Narrow', sans-serif" style="font-family: 'Archivo Narrow', sans-serif;">Archivo Narrow</div>
          <div class="font-item" data-font="'Manrope', sans-serif" style="font-family: 'Manrope', sans-serif;">Manrope</div>
          <div class="font-item" data-font="'DM Sans', sans-serif" style="font-family: 'DM Sans', sans-serif;">DM Sans</div>
          <div class="font-item" data-font="'DM Serif Display', serif" style="font-family: 'DM Serif Display', serif;">DM Serif</div>
          <div class="font-item" data-font="'Literata', serif" style="font-family: 'Literata', serif;">Literata</div>
          <div class="font-item" data-font="'Mulish', sans-serif" style="font-family: 'Mulish', sans-serif;">Mulish</div>
          <div class="font-item" data-font="'Sora', sans-serif" style="font-family: 'Sora', sans-serif;">Sora</div>
          <div class="font-item" data-font="'Fraunces', serif" style="font-family: 'Fraunces', serif;">Fraunces</div>
          <div class="font-item" data-font="'Epilogue', sans-serif" style="font-family: 'Epilogue', sans-serif;">Epilogue</div>
          <div class="font-item" data-font="'Outfit', sans-serif" style="font-family: 'Outfit', sans-serif;">Outfit</div>
          <div class="font-item" data-font="'Urbanist', sans-serif" style="font-family: 'Urbanist', sans-serif;">Urbanist</div>
          <div class="font-item" data-font="'Lexend', sans-serif" style="font-family: 'Lexend', sans-serif;">Lexend</div>
          <div class="font-item" data-font="'Plus Jakarta Sans', sans-serif" style="font-family: 'Plus Jakarta Sans', sans-serif;">Jakarta</div>
          <div class="font-item" data-font="'Figtree', sans-serif" style="font-family: 'Figtree', sans-serif;">Figtree</div>
          <div class="font-item" data-font="'Instrument Sans', sans-serif" style="font-family: 'Instrument Sans', sans-serif;">Instrument</div>
          <div class="font-item" data-font="'Gabarito', sans-serif" style="font-family: 'Gabarito', sans-serif;">Gabarito</div>
          <div class="font-item" data-font="'Noto Sans Display', sans-serif" style="font-family: 'Noto Sans Display', sans-serif;">Noto Display</div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Font Size: <span id="fontSizeValue">32</span>px</label>
        <input type="range" class="form-range" id="fontSize" min="12" max="500" value="32">
      </div>

      <div class="form-group">
        <label class="form-label">Text Color</label>
        <input type="color" class="color-input" id="textColor" value="#000000">
      </div>

      <div class="form-group">
        <label class="form-label">Background Color</label>
        <input type="color" class="color-input" id="textBgColor" value="#ffffff">
        <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
          <input type="checkbox" id="transparentBg" checked>
          <span style="font-size: 12px;">Transparent Background</span>
        </label>
      </div>

      <!-- Front and back positioning controls removed -->

      <div class="form-group">
        <label class="form-label">Text Align</label>
        <select class="form-select" id="textAlign">
          <option value="left">Left</option>
          <option value="center">Center</option>
          <option value="right">Right</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Font Weight</label>
        <select class="form-select" id="fontWeight">
          <option value="normal">Normal</option>
          <option value="bold">Bold</option>
          <option value="bolder">Extra Bold</option>
          <option value="lighter">Light</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Font Style</label>
        <select class="form-select" id="fontStyle">
          <option value="normal">Normal</option>
          <option value="italic">Italic</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Text Shadow</label>
        <select class="form-select" id="textShadow">
          <option value="none">None</option>
          <option value="1px 1px 2px rgba(0,0,0,0.3)">Light</option>
          <option value="2px 2px 4px rgba(0,0,0,0.5)">Medium</option>
          <option value="3px 3px 6px rgba(0,0,0,0.7)">Heavy</option>
          <option value="0 0 10px rgba(255,255,255,0.8)">Glow</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Rotation: <span id="rotationValue">0</span>¬∞</label>
        <input type="range" class="form-range" id="textRotation" min="0" max="360" value="0">
      </div>

      <div class="form-group">
        <label class="form-label">3D Effects</label>
        <select class="form-select" id="text3dEffect">
          <option value="none">None</option>
          <option value="isometric">Isometric</option>
          <option value="perspective">Perspective</option>
          <option value="rotateX">Rotate X</option>
          <option value="rotateY">Rotate Y</option>
        </select>
      </div>
      
      <div id="3dCustomOptions" style="display: none;">
        <div class="form-group" id="rotateXControl">
          <label class="form-label">Rotate X (degrees)</label>
          <div class="range-with-value">
            <input type="range" class="form-range" id="rotateXValue" min="-360" max="360" value="30">
            <span class="range-value" id="rotateXDisplay">30¬∞</span>
          </div>
        </div>
        
        <div class="form-group" id="rotateYControl">
          <label class="form-label">Rotate Y (degrees)</label>
          <div class="range-with-value">
            <input type="range" class="form-range" id="rotateYValue" min="-360" max="360" value="-30">
            <span class="range-value" id="rotateYDisplay">-30¬∞</span>
          </div>
        </div>
        
        <div class="form-group" id="perspectiveControl">
          <label class="form-label">Perspective (px)</label>
          <div class="range-with-value">
            <input type="range" class="form-range" id="perspectiveValue" min="100" max="1000" value="500">
            <span class="range-value" id="perspectiveDisplay">500px</span>
          </div>
        </div>
      </div>
    </div>



    <div class="tool-section">
      <div class="tool-title">Canvas Settings</div>
      
      <div class="form-group">
        <label class="form-label">Canvas Size</label>
        <select class="form-select" id="canvasSize">
          <option value="512x512">512 √ó 512 (Square)</option>
          <option value="1024x1024">1024 √ó 1024 (Large Square)</option>
          <option value="800x600">800 √ó 600 (Landscape)</option>
          <option value="600x800">600 √ó 800 (Portrait)</option>
          <option value="1920x1080">1920 √ó 1080 (HD)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Canvas Background</label>
        <input type="color" class="color-input" id="canvasBgColor" value="#ffffff">
        <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
          <input type="checkbox" id="transparentCanvasBg">
          <span style="font-size: 12px;">Transparent Canvas</span>
        </label>
      </div>
    </div>

    <div class="tool-section">
      <div class="tool-title">Export Options</div>
      <div class="export-grid">
        <button class="btn btn-accent" onclick="showExportOptions('png')">üñºÔ∏è PNG</button>
        <button class="btn" onclick="showExportOptions('jpg')">üì∏ JPG</button>
      </div>
    </div>
  </aside>
</main>

<!-- Status Messages -->
<div id="statusMessage" class="status-message"></div>

<script>
// Global variables
let uploadedImages = new Map(); // Store uploaded images with unique IDs
let currentEmoji = null;
let selectedTextLayer = null;
let selectedCanvasImage = null;
let currentPage = 1;
const itemsPerPage = 12;
let textLayerCounter = 0;
let imageCounter = 0;
let canvasImages = []; // Store images added to canvas
let history = [];
let dragCounter = 0;
let isResizing = false;
let originalWidth, originalHeight;
const imagesFolder = 'images/'; // Relative path to the folder containing images

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  initializeEventListeners();
  setupTextControls();
  setupFileUpload();
  loadImagesFromFolder();
  updateEmojiGrid();
  updatePagination();
  updateEmojiCount();
  
  // Initialize zoom and pan controls
  initZoomPanControls();
});

// Load images from folder automatically
function loadImagesFromFolder() {
  console.log('Loading images from folder:', imagesFolder);
  showStatusMessage(`Attempting to load images from: ${imagesFolder}`, 'success');
  let loadedCount = 0;
  let errorCount = 0;
  
  // Find all PNG files in the folder with numeric names
  for (let i = 1; i <= 55; i++) { // Updated to load all 55 images
    const imagePath = imagesFolder + i + '.png';
    console.log('Trying to load:', imagePath);
    
    const img = new Image();
    // Set crossOrigin to anonymous to prevent CORS issues
    img.crossOrigin = 'anonymous';
    
    // Log the full path to help with debugging
    const fullPath = new URL(imagePath, window.location.href).href;
    console.log('Full resolved path:', fullPath);
    
    // Use a closure to capture the correct value of i for each iteration
    (function(index) {
      img.onload = function() {
        loadedCount++;
        console.log(`Loaded image ${index}.png successfully`);
        
        const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        uploadedImages.set(imageId, {
          id: imageId,
          name: `${index}.png`,
          data: img.src,
          size: 0 // Size not available when loading from folder
        });
        
        updateEmojiGrid();
        updatePagination();
        updateEmojiCount();
        
        if (loadedCount === 1) {
          showStatusMessage(`Loaded ${loadedCount} image(s) from ${imagesFolder}`, 'success');
        } else if (loadedCount % 5 === 0) {
          showStatusMessage(`Loaded ${loadedCount} images from ${imagesFolder}`, 'success');
        }
      };
      
      img.onerror = function() {
        errorCount++;
        console.error(`Failed to load image ${index}.png from ${imagesFolder}`);
        
        // Only show detailed error message for the first few images
        if (index <= 3) {
          const fullPath = new URL(imagePath, window.location.href).href;
          showStatusMessage(`Failed to load image ${index}.png from ${imagesFolder}. Full path: ${fullPath}. Make sure images exist in this location.`, 'error');
        } else if (errorCount === 36) {
          // If all images failed to load, show a summary message
          showStatusMessage(`Failed to load all images. Please check that the images folder exists and contains PNG files named 1.png through 36.png.`, 'error');
        }
      };
    })(i);
    
    // Add cache-busting parameter to prevent browser caching
    img.src = imagePath + '?v=' + new Date().getTime();
  }
}

function initializeEventListeners() {
  // Canvas click to deselect
  document.getElementById('canvas').addEventListener('click', function(e) {
    if (e.target.id === 'canvas' || e.target.classList.contains('canvas-bg-image')) {
      deselectAllTextLayers();
      deselectAllCanvasImages();
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Delete') {
      if (selectedTextLayer) {
        deleteTextLayer(selectedTextLayer);
      } else if (selectedCanvasImage) {
        deleteCanvasImage(selectedCanvasImage);
      }
    }
    if (e.ctrlKey || e.metaKey) {
      if (e.key === 'z') {
        e.preventDefault();
        undoAction();
      }
    }
  });

  // Window resize
  window.addEventListener('resize', debounce(handleWindowResize, 300));
  
  // Image filter controls were removed
  
  // Text position controls removed
  
  // Add image to canvas button (right-click on emoji)
  document.querySelectorAll('.emoji-item').forEach(item => {
    item.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      const emojiId = this.dataset.id;
      displayEmojiOnCanvas(emojiId, false); // false = add as movable image
    });
  });
}

function deselectAllCanvasImages() {
  document.querySelectorAll('.canvas-image').forEach(img => {
    img.classList.remove('selected');
  });
  selectedCanvasImage = null;
  document.getElementById('imageEditingControls').style.display = 'none';
}

// Image filter functions removed

function setupFileUpload() {
  // Add import images button to the UI
  const navPanel = document.querySelector('.nav-panel .nav-section');
  const importButton = document.createElement('div');
  importButton.className = 'form-group';
  importButton.style.padding = '10px';
  importButton.innerHTML = `
    <label class="nav-title">Import Images</label>
    <div class="input-group" style="margin-top: 8px;">
      <input type="file" id="imageImport" accept="image/*" multiple class="form-control" style="display: none;">
      <button id="importImagesBtn" class="btn btn-accent" style="width: 100%;">Import from Device</button>
    </div>
  `;
  
  // Insert the import button at the top of the nav panel
  navPanel.insertBefore(importButton, navPanel.firstChild);
  
  // Add event listener to the import button
  document.getElementById('importImagesBtn').addEventListener('click', function() {
    document.getElementById('imageImport').click();
  });
  
  // Add event listener to the file input
  document.getElementById('imageImport').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      handleFiles(e.target.files);
      e.target.value = ''; // Reset the input to allow selecting the same files again
    }
  });
  
  console.log('File upload functionality enabled');
}

function handleFiles(files) {
  const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
  
  Array.from(files).forEach(file => {
    if (!validTypes.includes(file.type)) {
      showStatusMessage('Please upload valid image files (PNG, JPG, GIF, WebP)', 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      uploadedImages.set(imageId, {
        id: imageId,
        name: file.name,
        data: e.target.result,
        size: file.size
      });
      
      updateEmojiGrid();
      updatePagination();
      updateEmojiCount();
      showStatusMessage(`Image "${file.name}" uploaded successfully!`, 'success');
    };
    reader.readAsDataURL(file);
  });
}

function updateEmojiGrid() {
  const grid = document.getElementById('emojiGrid');
  const imagesArray = Array.from(uploadedImages.values());
  const totalImages = imagesArray.length;
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalImages);
  
  grid.innerHTML = '';
  
  // Show images for current page
  for (let i = startIndex; i < endIndex; i++) {
    const imageData = imagesArray[i];
    const item = createEmojiItem(imageData);
    grid.appendChild(item);
  }
  
  // Fill remaining slots with placeholders if needed
  const remainingSlots = itemsPerPage - (endIndex - startIndex);
  for (let i = 0; i < remainingSlots; i++) {
    const placeholder = createPlaceholderItem();
    grid.appendChild(placeholder);
  }
}

function createEmojiItem(imageData) {
  const item = document.createElement('div');
  item.className = 'emoji-item';
  item.dataset.emojiId = imageData.id;
  
  const img = document.createElement('img');
  img.crossOrigin = 'anonymous'; // Add crossOrigin attribute
  img.src = imageData.data;
  img.alt = imageData.name;
  img.title = imageData.name;
  
  // Add error handling for image loading
  img.onerror = function() {
    console.error(`Failed to load emoji image: ${imageData.name}`);
    // Replace with a placeholder if image fails to load
    img.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"%3E%3Crect width="40" height="40" fill="%23f0f0f0"%3E%3C/rect%3E%3Ctext x="50%" y="50%" font-size="6" text-anchor="middle" dominant-baseline="middle" fill="%23999"%3EImage%3C/text%3E%3C/svg%3E';
  };
  
  item.appendChild(img);
  
  item.onclick = () => selectEmoji(imageData.id);
  
  return item;
}

function createPlaceholderItem() {
  const item = document.createElement('div');
  item.className = 'emoji-item';
  
  const placeholder = document.createElement('div');
  placeholder.className = 'emoji-placeholder';
  placeholder.innerHTML = '';
  placeholder.title = 'Empty slot';
  
  item.appendChild(placeholder);
  
  return item;
}

function updatePagination() {
  const pagination = document.getElementById('pagination');
  const totalPages = Math.ceil(uploadedImages.size / itemsPerPage);
  
  pagination.innerHTML = '';
  
  if (totalPages <= 1) return;
  
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
    btn.textContent = i;
    btn.onclick = () => goToPage(i);
    pagination.appendChild(btn);
  }
}

function goToPage(page) {
  currentPage = page;
  updateEmojiGrid();
  updatePagination();
}

function updateEmojiCount() {
  document.getElementById('emojiCount').textContent = uploadedImages.size;
}

function deleteImage(imageId) {
  uploadedImages.delete(imageId);
  
  // If current emoji was deleted, clear canvas
  if (currentEmoji === imageId) {
    clearCanvas();
  }
  
  // Adjust pagination if needed
  const totalPages = Math.ceil(uploadedImages.size / itemsPerPage);
  if (currentPage > totalPages && totalPages > 0) {
    currentPage = totalPages;
  } else if (totalPages === 0) {
    currentPage = 1;
  }
  
  updateEmojiGrid();
  updatePagination();
  updateEmojiCount();
  showStatusMessage('Image deleted successfully!', 'success');
}

function selectEmoji(emojiId) {
  // Remove previous active state
  document.querySelectorAll('.emoji-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Add active state to selected emoji
  const selectedItem = document.querySelector(`[data-emoji-id="${emojiId}"]`);
  if (selectedItem) {
    selectedItem.classList.add('active');
  }
  
  currentEmoji = emojiId;
  displayEmojiOnCanvas(emojiId);
  
  // Hide placeholder
  const placeholder = document.getElementById('canvasPlaceholder');
  if (placeholder) {
    placeholder.style.display = 'none';
  }
  
  saveState();
}

function displayEmojiOnCanvas(emojiId, asBackground = true) {
  const canvas = document.getElementById('canvas');
  const imageData = uploadedImages.get(emojiId);
  
  if (!imageData) return;
  
  if (asBackground) {
    // Clear existing background image
    const existingBg = canvas.querySelector('.canvas-bg-image');
    if (existingBg) {
      existingBg.remove();
    }
    
    // Create new background image
    const bgImage = document.createElement('img');
    bgImage.className = 'canvas-bg-image';
    bgImage.crossOrigin = 'anonymous'; // Add crossOrigin attribute
    bgImage.src = imageData.data;
    bgImage.alt = imageData.name;
    
    // Add error handling for image loading
    bgImage.onerror = function() {
      console.error(`Failed to load canvas background image: ${imageData.name}`);
      showStatusMessage('Failed to load image. Please try another one.', 'error');
      // Add a colored background as fallback
      canvas.style.backgroundColor = '#f0f0f0';
    };
    
    canvas.appendChild(bgImage);
    
    // Ensure text layers stay on top
    const textLayers = canvas.querySelectorAll('.text-overlay');
    textLayers.forEach(layer => {
      canvas.appendChild(layer);
    });
  } else {
    // Add as a movable image on canvas
    addImageToCanvas(imageData.data, imageData.name);
  }
  
  // Hide placeholder if it exists
  const placeholder = document.getElementById('canvasPlaceholder');
  if (placeholder) {
    placeholder.style.display = 'none';
  }
}

function addImageToCanvas(imageSrc, altText = 'Image') {
  const canvas = document.getElementById('canvas');
  imageCounter++;
  
  // Create image container
  const imageContainer = document.createElement('div');
  imageContainer.className = 'canvas-image';
  imageContainer.dataset.id = 'image-' + imageCounter;
  imageContainer.id = `canvas-image-${imageCounter}`;
  
  // Image selection click event removed
  
  // Create the image element
  const img = document.createElement('img');
  img.src = imageSrc;
  img.alt = altText;
  img.crossOrigin = 'anonymous';
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.objectFit = 'contain';
  
  // Set initial size and position
  imageContainer.style.width = '150px';
  imageContainer.style.height = '150px';
  imageContainer.style.left = '50px';
  imageContainer.style.top = '50px';
  
  // Add resize handle
  const resizeHandle = document.createElement('div');
  resizeHandle.className = 'resize-handle';
  
  // Add delete handle
  const deleteHandle = document.createElement('div');
  deleteHandle.className = 'delete-handle';
  deleteHandle.innerHTML = '√ó';
  deleteHandle.onclick = (e) => {
    e.stopPropagation();
    deleteCanvasImage(imageContainer);
  };
  
  // Add elements to container
  imageContainer.appendChild(img);
  imageContainer.appendChild(resizeHandle);
  imageContainer.appendChild(deleteHandle);
  
  // Add to canvas
  canvas.appendChild(imageContainer);
  
  // Make it interactive
  makeCanvasImageInteractive(imageContainer);
  
  // Select the new image
  selectCanvasImage(imageContainer);
  
  // Add to tracking array
  canvasImages.push({
    id: imageContainer.id,
    element: imageContainer
  });
  
  // Show image editing controls
  document.getElementById('imageEditingControls').style.display = 'block';
  
  return imageContainer;
}

function makeCanvasImageInteractive(imageContainer) {
  imageContainer.addEventListener('mousedown', function(e) {
    // Ignore if clicking on resize or delete handle
    if (e.target.classList.contains('resize-handle') || e.target.classList.contains('delete-handle')) {
      return;
    }
    
    e.preventDefault();
    selectCanvasImage(imageContainer);
    
    isDragging = true;
    imageContainer.classList.add('dragging');
    
    // Store initial position
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    originalLeft = parseInt(imageContainer.style.left) || 0;
    originalTop = parseInt(imageContainer.style.top) || 0;
    
    // Add mouse move and up events to document
    document.addEventListener('mousemove', handleImageDrag);
    document.addEventListener('mouseup', stopImageDrag);
  });
  
  // Set up resize functionality
  const resizeHandle = imageContainer.querySelector('.resize-handle');
  resizeHandle.addEventListener('mousedown', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    isResizing = true;
    
    // Store initial size and mouse position
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    originalWidth = parseInt(imageContainer.style.width) || 150;
    originalHeight = parseInt(imageContainer.style.height) || 150;
    
    // Add mouse move and up events to document
    document.addEventListener('mousemove', handleImageResize);
    document.addEventListener('mouseup', stopImageResize);
  });
}

function handleImageDrag(e) {
  if (!isDragging) return;
  
  const dx = e.clientX - dragStartX;
  const dy = e.clientY - dragStartY;
  
  const selectedImage = document.querySelector('.canvas-image.selected');
  if (selectedImage) {
    selectedImage.style.left = `${originalLeft + dx}px`;
    selectedImage.style.top = `${originalTop + dy}px`;
  }
}

function stopImageDrag() {
  if (!isDragging) return;
  
  isDragging = false;
  const selectedImage = document.querySelector('.canvas-image.dragging');
  if (selectedImage) {
    selectedImage.classList.remove('dragging');
  }
  
  document.removeEventListener('mousemove', handleImageDrag);
  document.removeEventListener('mouseup', stopImageDrag);
  
  saveState();
}

function handleImageResize(e) {
  if (!isResizing) return;
  
  const dx = e.clientX - dragStartX;
  const dy = e.clientY - dragStartY;
  
  const selectedImage = document.querySelector('.canvas-image.selected');
  if (selectedImage) {
    const newWidth = Math.max(50, originalWidth + dx);
    const newHeight = Math.max(50, originalHeight + dy);
    
    selectedImage.style.width = `${newWidth}px`;
    selectedImage.style.height = `${newHeight}px`;
  }
}

function stopImageResize() {
  if (!isResizing) return;
  
  isResizing = false;
  
  document.removeEventListener('mousemove', handleImageResize);
  document.removeEventListener('mouseup', stopImageResize);
  
  saveState();
}

function selectCanvasImage(imageContainer) {
  // Deselect all images
  document.querySelectorAll('.canvas-image').forEach(img => {
    img.classList.remove('selected');
  });
  
  // Deselect all text layers
  deselectAllTextLayers();
  
  // Select this image
  imageContainer.classList.add('selected');
  selectedCanvasImage = imageContainer;
  
  // Show image editing controls
  document.getElementById('imageEditingControls').style.display = 'block';
  
  // Update image filter values based on selected image
  updateImageFilterControls();
}

function deleteCanvasImage(imageContainer) {
  // Remove from DOM
  imageContainer.remove();
  
  // Remove from tracking array
  canvasImages = canvasImages.filter(img => img.id !== imageContainer.id);
  
  // Clear selection if this was selected
  if (selectedCanvasImage === imageContainer) {
    selectedCanvasImage = null;
    
    // Hide image editing controls if no image is selected
    if (canvasImages.length === 0) {
      document.getElementById('imageEditingControls').style.display = 'none';
    }
  }
  
  saveState();
}

function updateImageFilterControls() {
  if (!selectedCanvasImage) return;
  
  const img = selectedCanvasImage.querySelector('img');
  const style = img.style;
  
  // Extract current filter values or set defaults
  let brightness = 100;
  let contrast = 100;
  let saturation = 100;
  let blur = 0;
  
  if (style.filter) {
    const filterString = style.filter;
    
    // Extract brightness
    const brightnessMatch = filterString.match(/brightness\(([\d.]+)%\)/);
    if (brightnessMatch) brightness = parseFloat(brightnessMatch[1]);
    
    // Extract contrast
    const contrastMatch = filterString.match(/contrast\(([\d.]+)%\)/);
    if (contrastMatch) contrast = parseFloat(contrastMatch[1]);
    
    // Extract saturation
    const saturationMatch = filterString.match(/saturate\(([\d.]+)%\)/);
    if (saturationMatch) saturation = parseFloat(saturationMatch[1]);
    
    // Extract blur
    const blurMatch = filterString.match(/blur\(([\d.]+)px\)/);
    if (blurMatch) blur = parseFloat(blurMatch[1]);
  }
}

// All image filter related code has been removed

function addTextLayer() {
  const canvas = document.getElementById('canvas');
  textLayerCounter++;
  
  const textLayer = document.createElement('div');
  textLayer.className = 'text-overlay';
  textLayer.id = `text-layer-${textLayerCounter}`;
  textLayer.contentEditable = true;
  textLayer.textContent = 'Edit me';
  
  // Position in center of canvas
  const canvasRect = canvas.getBoundingClientRect();
  const x = (canvas.offsetWidth / 2) - 50;
  const y = (canvas.offsetHeight / 2) - 20;
  
  textLayer.style.cssText = `
    left: ${x}px;
    top: ${y}px;
    font-family: Arial;
    font-size: 32px;
    color: #000000;
    font-weight: normal;
    font-style: normal;
    text-align: left;
    background: transparent;
    min-width: 100px;
    z-index: 10;
    text-shadow: none;
  `;
  
  // Add control handles
  const resizeHandle = document.createElement('div');
  resizeHandle.className = 'resize-handle';
  
  const deleteHandle = document.createElement('div');
  deleteHandle.className = 'delete-handle';
  deleteHandle.innerHTML = '√ó';
  deleteHandle.onclick = (e) => {
    e.stopPropagation();
    deleteTextLayer(textLayer);
  };
  
  textLayer.appendChild(resizeHandle);
  textLayer.appendChild(deleteHandle);
  
  canvas.appendChild(textLayer);
  
  // Make it interactive
  makeTextLayerInteractive(textLayer);
  
  // Select the new text layer
  selectTextLayer(textLayer);
  
  // Focus for immediate editing
  setTimeout(() => {
    textLayer.focus();
    selectAllText(textLayer);
  }, 50);
  
  saveState();
}

function makeTextLayerInteractive(textLayer) {
  let isDragging = false;
  let isResizing = false;
  let startX, startY, startLeft, startTop, startWidth, startFontSize;
  
  // Selection and editing
  textLayer.addEventListener('click', (e) => {
    e.stopPropagation();
    selectTextLayer(textLayer);
  });
  
  textLayer.addEventListener('dblclick', (e) => {
    e.stopPropagation();
    textLayer.contentEditable = true;
    textLayer.focus();
    selectAllText(textLayer);
  });
  
  // Input handling
  textLayer.addEventListener('input', () => {
    if (selectedTextLayer === textLayer) {
      updateTextContentControl();
    }
  });
  
  textLayer.addEventListener('blur', () => {
    textLayer.contentEditable = false;
  });
  
  // Prevent default drag behavior on the text itself
  textLayer.addEventListener('dragstart', (e) => {
    e.preventDefault();
  });
  
  // Mouse down for dragging
  textLayer.addEventListener('mousedown', (e) => {
    if (e.target.classList.contains('resize-handle')) {
      // Resize mode
      isResizing = true;
      startX = e.clientX;
      startY = e.clientY;
      startFontSize = parseInt(window.getComputedStyle(textLayer).fontSize);
      e.preventDefault();
    } else if (e.target.classList.contains('delete-handle')) {
      // Delete button clicked - handled by onclick
      return;
    } else {
      // Drag mode
      isDragging = true;
      textLayer.classList.add('dragging');
      startX = e.clientX;
      startY = e.clientY;
      startLeft = textLayer.offsetLeft;
      startTop = textLayer.offsetTop;
      textLayer.contentEditable = false;
      e.preventDefault();
    }
    
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });
  
  function onMouseMove(e) {
    if (isDragging) {
      const canvas = textLayer.parentElement;
      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;
      
      let newLeft = startLeft + deltaX;
      let newTop = startTop + deltaY;
      
      // Keep within canvas bounds
      newLeft = Math.max(0, Math.min(newLeft, canvas.offsetWidth - textLayer.offsetWidth));
      newTop = Math.max(0, Math.min(newTop, canvas.offsetHeight - textLayer.offsetHeight));
      
      textLayer.style.left = newLeft + 'px';
      textLayer.style.top = newTop + 'px';
    } else if (isResizing) {
      const deltaX = e.clientX - startX;
      const scaleFactor = 1 + (deltaX / 100);
      const newFontSize = Math.max(12, Math.min(500, startFontSize * scaleFactor));
      
      textLayer.style.fontSize = newFontSize + 'px';
      
      // Update controls
      if (selectedTextLayer === textLayer) {
        document.getElementById('fontSize').value = newFontSize;
        document.getElementById('fontSizeValue').textContent = Math.round(newFontSize);
      }
    }
  }
  
  function onMouseUp(e) {
    isDragging = false;
    isResizing = false;
    textLayer.classList.remove('dragging');
    
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    
    if (selectedTextLayer === textLayer) {
      saveState();
    }
  }
}

function selectTextLayer(textLayer) {
  // Remove selection from all text layers
  document.querySelectorAll('.text-overlay').forEach(layer => {
    layer.classList.remove('selected');
  });
  
  // Select the clicked layer
  textLayer.classList.add('selected');
  selectedTextLayer = textLayer;
  
  // Update the text controls to match the selected layer
  updateTextControlsFromLayer(textLayer);
}

function deselectAllTextLayers() {
  document.querySelectorAll('.text-overlay').forEach(layer => {
    layer.classList.remove('selected');
    layer.contentEditable = false;
  });
  selectedTextLayer = null;
}

function deleteTextLayer(textLayer) {
  textLayer.remove();
  if (selectedTextLayer === textLayer) {
    selectedTextLayer = null;
  }
  saveState();
  showStatusMessage('Text layer deleted', 'success');
}

function updateTextControlsFromLayer(textLayer) {
  const computedStyle = window.getComputedStyle(textLayer);
  
  // Get clean text content (without control handles)
  const textContent = Array.from(textLayer.childNodes)
    .filter(node => node.nodeType === Node.TEXT_NODE)
    .map(node => node.textContent)
    .join('');
  
  document.getElementById('textContent').value = textContent;
  document.getElementById('fontSize').value = parseInt(computedStyle.fontSize);
  document.getElementById('fontSizeValue').textContent = parseInt(computedStyle.fontSize);
  document.getElementById('textColor').value = rgbToHex(computedStyle.color);
  
  // Font weight
  const fontWeight = computedStyle.fontWeight;
  document.getElementById('fontWeight').value = fontWeight === '700' ? 'bold' : fontWeight;
  
  document.getElementById('fontStyle').value = computedStyle.fontStyle;
  document.getElementById('textAlign').value = computedStyle.textAlign;
  
  // Background color
  const bgColor = computedStyle.backgroundColor;
  if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    document.getElementById('textBgColor').value = rgbToHex(bgColor);
    document.getElementById('transparentBg').checked = false;
  } else {
    document.getElementById('transparentBg').checked = true;
  }
  
  // Font family selection
  const fontFamily = computedStyle.fontFamily.split(',')[0].replace(/['"]/g, '').trim();
  document.querySelectorAll('.font-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.font.replace(/['"]/g, '') === fontFamily) {
      item.classList.add('active');
    }
  });
  
  // Get rotation value
  const transform = computedStyle.transform;
  let rotation = 0;
  if (transform && transform !== 'none') {
    const match = transform.match(/rotate\((\d+)deg\)/);
    if (match && match[1]) {
      rotation = parseInt(match[1]);
    }
  }
  document.getElementById('textRotation').value = rotation;
  document.getElementById('rotationValue').textContent = rotation;
  
  // Detect 3D effect
  const effect3d = detect3DEffect(textLayer);
  document.getElementById('text3dEffect').value = effect3d;
}

function updateTextContentControl() {
  if (!selectedTextLayer) return;
  
  const textContent = Array.from(selectedTextLayer.childNodes)
    .filter(node => node.nodeType === Node.TEXT_NODE)
    .map(node => node.textContent)
    .join('');
  
  document.getElementById('textContent').value = textContent;
}

// Zoom and pan functionality has been removed
// Zoom and pan variables removed

function initZoomPanControls() {
  // Function kept for compatibility but zoom and pan controls have been removed
  console.log('Zoom and pan controls have been removed');
}

function setupTextControls() {
  // Text content
  document.getElementById('textContent').addEventListener('input', (e) => {
    updateSelectedTextContent(e.target.value);
  });
  
  // Font size
  document.getElementById('fontSize').addEventListener('input', (e) => {
    document.getElementById('fontSizeValue').textContent = e.target.value;
    updateSelectedTextStyle('fontSize', e.target.value + 'px');
  });
  
  
  // Text color
  document.getElementById('textColor').addEventListener('change', (e) => {
    updateSelectedTextStyle('color', e.target.value);
  });
  
  // Background color
  document.getElementById('textBgColor').addEventListener('change', updateTextBackground);
  document.getElementById('transparentBg').addEventListener('change', updateTextBackground);
  
  // Text align
  document.getElementById('textAlign').addEventListener('change', (e) => {
    updateSelectedTextStyle('textAlign', e.target.value);
  });
  
  // Font weight
  document.getElementById('fontWeight').addEventListener('change', (e) => {
    updateSelectedTextStyle('fontWeight', e.target.value);
  });
  
  // Font style
  document.getElementById('fontStyle').addEventListener('change', (e) => {
    updateSelectedTextStyle('fontStyle', e.target.value);
  });
  
  // Text shadow
  document.getElementById('textShadow').addEventListener('change', (e) => {
    updateSelectedTextStyle('textShadow', e.target.value);
  });
  
  // Font family
  document.querySelectorAll('.font-item').forEach(item => {
    item.addEventListener('click', () => {
      document.querySelectorAll('.font-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      updateSelectedTextStyle('fontFamily', item.dataset.font);
    });
  });
  
  // Text rotation
  document.getElementById('textRotation').addEventListener('input', (e) => {
    document.getElementById('rotationValue').textContent = e.target.value;
    updateSelectedTextStyle('transform', `rotate(${e.target.value}deg)`);
  });
  
  // 3D effects
  document.getElementById('text3dEffect').addEventListener('change', (e) => {
    apply3DEffect(e.target.value);
  });
  
  // 3D custom controls
  document.getElementById('rotateXValue').addEventListener('input', (e) => {
    document.getElementById('rotateXDisplay').textContent = e.target.value + '¬∞';
    apply3DEffect(document.getElementById('text3dEffect').value);
  });
  
  document.getElementById('rotateYValue').addEventListener('input', (e) => {
    document.getElementById('rotateYDisplay').textContent = e.target.value + '¬∞';
    apply3DEffect(document.getElementById('text3dEffect').value);
  });
  
  document.getElementById('perspectiveValue').addEventListener('input', (e) => {
    document.getElementById('perspectiveDisplay').textContent = e.target.value + 'px';
    apply3DEffect(document.getElementById('text3dEffect').value);
  });
  
  // Canvas background
  document.getElementById('canvasBgColor').addEventListener('change', (e) => {
    updateCanvasBackground();
  });
  
  document.getElementById('transparentCanvasBg').addEventListener('change', (e) => {
    updateCanvasBackground();
  });
  
  // Canvas size
  document.getElementById('canvasSize').addEventListener('change', (e) => {
    const [width, height] = e.target.value.split('x');
    const canvas = document.getElementById('canvas');
    const canvasContainer = document.querySelector('.canvas-container');
    
    // Set canvas dimensions
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    
    // Enable scrolling for large canvas sizes
    if (parseInt(width) > 1000 || parseInt(height) > 800) {
      // Enable scrolling on canvas container
      canvasContainer.style.overflow = 'auto';
      canvasContainer.style.maxWidth = '100%';
      canvasContainer.style.maxHeight = '80vh';
    } else {
      // Reset for smaller canvas sizes
      canvasContainer.style.overflow = 'visible';
      canvasContainer.style.maxHeight = 'none';
      canvas.style.transform = 'scale(1)';
    }
  });
}

function updateSelectedTextContent(content) {
  if (!selectedTextLayer) return;
  
  // Store control handles
  const resizeHandle = selectedTextLayer.querySelector('.resize-handle');
  const deleteHandle = selectedTextLayer.querySelector('.delete-handle');
  
  // Update text content
  selectedTextLayer.textContent = content;
  
  // Re-add control handles
  if (resizeHandle) selectedTextLayer.appendChild(resizeHandle);
  if (deleteHandle) selectedTextLayer.appendChild(deleteHandle);
}

function updateSelectedTextStyle(property, value) {
  if (selectedTextLayer) {
    selectedTextLayer.style[property] = value;
    saveState();
  }
}

function updateTextBackground() {
  if (!selectedTextLayer) return;
  
  const isTransparent = document.getElementById('transparentBg').checked;
  const bgColor = document.getElementById('textBgColor').value;
  
  selectedTextLayer.style.backgroundColor = isTransparent ? 'transparent' : bgColor;
  selectedTextLayer.style.padding = isTransparent ? '4px' : '8px 12px';
  selectedTextLayer.style.borderRadius = isTransparent ? '0' : '4px';
  
  saveState();
}

function updateCanvasBackground() {
  const canvas = document.getElementById('canvas');
  const isTransparent = document.getElementById('transparentCanvasBg').checked;
  const bgColor = document.getElementById('canvasBgColor').value;
  
  // Set the background color directly on the canvas element
  canvas.style.backgroundColor = isTransparent ? 'transparent' : bgColor;
  
  // Log for debugging
  console.log('Canvas background updated:', isTransparent ? 'transparent' : bgColor);
}

function fitToCanvas() {
  const canvas = document.getElementById('canvas');
  const canvasContainer = document.getElementById('canvasContainer');
  const bgImage = canvas.querySelector('.canvas-bg-image');
  
  // Handle background image fitting if present
  if (bgImage) {
    bgImage.style.objectFit = bgImage.style.objectFit === 'contain' ? 'cover' : 'contain';
    showStatusMessage(`Image fit: ${bgImage.style.objectFit}`, 'success');
  }
  
  // Reset canvas position
  canvas.style.transform = 'scale(1)';
  canvas.style.transformOrigin = 'center';
  
  // Ensure canvas is visible within container
  canvasContainer.scrollTop = 0;
  canvasContainer.scrollLeft = 0;
}

function clearCanvas() {
  const canvas = document.getElementById('canvas');
  canvas.innerHTML = '<div class="canvas-placeholder" id="canvasPlaceholder">Upload and select an image from the library to start designing</div>';
  
  currentEmoji = null;
  selectedTextLayer = null;
  
  // Reset emoji selection
  document.querySelectorAll('.emoji-item').forEach(item => {
    item.classList.remove('active');
  });
  
  saveState();
  showStatusMessage('Canvas cleared', 'success');
}

function toggleGrid() {
  const canvas = document.getElementById('canvas');
  const gridOverlay = document.getElementById('gridOverlay');
  
  // Create grid overlay if it doesn't exist
  if (!gridOverlay) {
    const overlay = document.createElement('div');
    overlay.id = 'gridOverlay';
    overlay.style.position = 'absolute';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.pointerEvents = 'none'; // Allow clicks to pass through
    overlay.style.zIndex = '50'; // Above images but below text layers
    canvas.appendChild(overlay);
  }
  
  // Toggle grid visibility
  if (gridOverlay && gridOverlay.style.backgroundImage && gridOverlay.style.backgroundImage.includes('linear-gradient')) {
    gridOverlay.style.backgroundImage = '';
    gridOverlay.style.backgroundSize = '';
  } else if (gridOverlay) {
    gridOverlay.style.backgroundImage = `
      linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px)
    `;
    gridOverlay.style.backgroundSize = '20px 20px';
  }
}

function saveState() {
  const canvas = document.getElementById('canvas');
  history.push({
    html: canvas.innerHTML,
    currentEmoji: currentEmoji
  });
  
  // Limit history to last 20 states
  if (history.length > 20) {
    history.shift();
  }
}

function undoAction() {
  if (history.length > 1) {
    // Remove current state
    history.pop();
    // Get previous state
    const previousState = history[history.length - 1];
    
    const canvas = document.getElementById('canvas');
    canvas.innerHTML = previousState.html;
    currentEmoji = previousState.currentEmoji;
    
    // Re-initialize text layers
    document.querySelectorAll('.text-overlay').forEach(layer => {
      makeTextLayerInteractive(layer);
    });
    
    // Update emoji selection
    document.querySelectorAll('.emoji-item').forEach(item => {
      item.classList.remove('active');
    });
    
    if (currentEmoji) {
      const selectedItem = document.querySelector(`[data-emoji-id="${currentEmoji}"]`);
      if (selectedItem) {
        selectedItem.classList.add('active');
      }
    }
    
    selectedTextLayer = null;
    showStatusMessage('Undo successful', 'success');
  } else {
    showStatusMessage('Nothing to undo', 'error');
  }
}

function showExportOptions(format) {
  // Remove any existing modal to prevent event listener issues
  let existingModal = document.getElementById('exportOptionsModal');
  if (existingModal) {
    document.body.removeChild(existingModal);
  }
  
  // Create a new modal each time
  let modal = document.createElement('div');
  modal.id = 'exportOptionsModal';
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>Export Options</h3>
      <div class="form-group">
        <label class="form-label">Resolution</label>
        <select id="exportResolution" class="form-select">
          <option value="original">Original Size</option>
          <option value="128">128px</option>
          <option value="256">256px</option>
          <option value="512">512px</option>
          <option value="1024">1024px</option>
          <option value="hd">1920px (HD)</option>
        </select>
      </div>
      <div class="form-group" id="qualityGroup" style="display: none;">
        <label class="form-label">Quality: <span id="qualityValue">90</span>%</label>
        <input type="range" class="form-range" id="exportQuality" min="10" max="100" value="90">
      </div>
      <button id="exportButton" class="btn btn-accent">Export</button>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Add event listeners
  document.querySelector('.close-button').addEventListener('click', () => {
    modal.style.display = 'none';
  });
  
  // Close modal when clicking outside
  window.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });
  
  // Update quality display
  document.getElementById('exportQuality').addEventListener('input', (e) => {
    document.getElementById('qualityValue').textContent = e.target.value;
  });
  
  // Show/hide quality slider based on format
  const qualityGroup = document.getElementById('qualityGroup');
  qualityGroup.style.display = (format === 'jpg') ? 'block' : 'none';
  
  // Set up export button action
  const exportButton = document.getElementById('exportButton');
  exportButton.addEventListener('click', () => {
    const resolution = document.getElementById('exportResolution').value;
    const quality = parseInt(document.getElementById('exportQuality').value) / 100;
    
    if (format === 'png') {
      exportPNG(resolution);
    } else if (format === 'jpg') {
      exportJPG(resolution, quality);
    // SVG export removed
    }
  });
  
  // Show modal
  modal.style.display = 'block';
}

function exportPNG(resolution = null) {
  try {
    const canvas = document.getElementById('canvas');
    const originalWidth = canvas.offsetWidth;
    const originalHeight = canvas.offsetHeight;
    
    // Determine export dimensions based on resolution
    let width = originalWidth;
    let height = originalHeight;
    
    if (resolution && resolution !== 'original') {
      if (resolution === '128') {
        width = 128;
        height = Math.round((128 / originalWidth) * originalHeight);
      } else if (resolution === '256') {
        width = 256;
        height = Math.round((256 / originalWidth) * originalHeight);
      } else if (resolution === '512') {
        width = 512;
        height = Math.round((512 / originalWidth) * originalHeight);
      } else if (resolution === '1024') {
        width = 1024;
        height = Math.round((1024 / originalWidth) * originalHeight);
      } else if (resolution === 'hd') {
        width = 1920;
        height = Math.round((1920 / originalWidth) * originalHeight);
      }
    }
    
    // Create temporary canvas
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = width;
    tempCanvas.height = height;
    const ctx = tempCanvas.getContext('2d');
    
    // Set canvas background
    const isTransparent = document.getElementById('transparentCanvasBg').checked;
    if (!isTransparent) {
      const bgColor = document.getElementById('canvasBgColor').value;
      ctx.fillStyle = bgColor;
      ctx.fillRect(0, 0, width, height);
    }
    
    const bgImage = canvas.querySelector('.canvas-bg-image');
    
    if (bgImage && bgImage.complete && bgImage.src) {
      // Create a new image to ensure proper loading
      const img = new Image();
      img.crossOrigin = 'Anonymous'; // Handle cross-origin images
      
      img.onload = function() {
        try {
          ctx.drawImage(img, 0, 0, width, height);
          // Draw additional canvas images with filters
          drawCanvasImages(ctx, canvas, width, height, width / originalWidth);
          // Draw text layers (background, normal, foreground)
          drawTextLayers(ctx, canvas, width, height, width / originalWidth);
          downloadCanvas(tempCanvas, `moodies-design-${width}x${height}.png`);
        } catch (err) {
          console.error('Error drawing image:', err);
          showStatusMessage('Error creating PNG. Please try again.', 'error');
        }
      };
      
      img.onerror = function() {
        console.error('Failed to load background image');
        // Continue without the background image
        drawCanvasImages(ctx, canvas, width, height, width / originalWidth);
        drawTextLayers(ctx, canvas, width, height, width / originalWidth);
        downloadCanvas(tempCanvas, `moodies-design-${width}x${height}.png`);
      };
      
      img.src = bgImage.src;
    } else {
      drawCanvasImages(ctx, canvas, width, height, width / originalWidth);
      drawTextLayers(ctx, canvas, width, height, width / originalWidth);
      downloadCanvas(tempCanvas, `moodies-design-${width}x${height}.png`);
    }
  } catch (error) {
    console.error('PNG export error:', error);
    showStatusMessage('An error occurred during PNG export. Please try again.', 'error');
  }
}

function exportJPG(resolution = null, quality = 0.9) {
  try {
    const canvas = document.getElementById('canvas');
    const originalWidth = canvas.offsetWidth;
    const originalHeight = canvas.offsetHeight;
    
    // Determine export dimensions based on resolution
    let width = originalWidth;
    let height = originalHeight;
    
    if (resolution && resolution !== 'original') {
      if (resolution === '128') {
        width = 128;
        height = Math.round((128 / originalWidth) * originalHeight);
      } else if (resolution === '256') {
        width = 256;
        height = Math.round((256 / originalWidth) * originalHeight);
      } else if (resolution === '512') {
        width = 512;
        height = Math.round((512 / originalWidth) * originalHeight);
      } else if (resolution === '1024') {
        width = 1024;
        height = Math.round((1024 / originalWidth) * originalHeight);
      } else if (resolution === 'hd') {
        width = 1920;
        height = Math.round((1920 / originalWidth) * originalHeight);
      }
    }
    
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = width;
    tempCanvas.height = height;
    const ctx = tempCanvas.getContext('2d');
    
    // JPG needs white background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, height);
    
    const bgImage = canvas.querySelector('.canvas-bg-image');
    
    if (bgImage && bgImage.complete && bgImage.src) {
      // Create a new image to ensure proper loading
      const img = new Image();
      img.crossOrigin = 'Anonymous'; // Handle cross-origin images
      
      img.onload = function() {
        try {
          ctx.drawImage(img, 0, 0, width, height);
          // Draw additional canvas images with filters
          drawCanvasImages(ctx, canvas, width, height, width / originalWidth);
          // Draw text layers (background, normal, foreground)
          drawTextLayers(ctx, canvas, width, height, width / originalWidth);
          downloadCanvas(tempCanvas, `moodies-design-${width}x${height}.jpg`, 'image/jpeg', quality);
        } catch (err) {
          console.error('Error drawing image:', err);
          showStatusMessage('Error creating JPG. Please try again.', 'error');
        }
      };
      
      img.onerror = function() {
        console.error('Failed to load background image');
        // Continue without the background image
        drawCanvasImages(ctx, canvas, width, height, width / originalWidth);
        drawTextLayers(ctx, canvas, width, height, width / originalWidth);
        downloadCanvas(tempCanvas, `moodies-design-${width}x${height}.jpg`, 'image/jpeg', quality);
      };
      
      img.src = bgImage.src;
    } else {
      drawCanvasImages(ctx, canvas, width, height, width / originalWidth);
      drawTextLayers(ctx, canvas, width, height, width / originalWidth);
      downloadCanvas(tempCanvas, `moodies-design-${width}x${height}.jpg`, 'image/jpeg', quality);
    }
  } catch (error) {
    console.error('JPG export error:', error);
    showStatusMessage('An error occurred during JPG export. Please try again.', 'error');
  }
}

// drawTextLayers function moved to external file

function downloadCanvas(canvas, filename, mimeType = 'image/png', quality = 0.9) {
  try {
    canvas.toBlob((blob) => {
      if (!blob) {
        showStatusMessage('Failed to create image blob. Please try again.', 'error');
        return;
      }
      
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      
      // Use setTimeout to ensure the click event is properly processed
      setTimeout(() => {
        a.click();
        
        // Use another setTimeout to ensure the download has started before cleanup
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showStatusMessage(`${filename} exported successfully!`, 'success');
          
          // Hide export options modal if it's open
          const modal = document.getElementById('exportOptionsModal');
          if (modal) modal.style.display = 'none';
        }, 100);
      }, 0);
    }, mimeType, quality);
  } catch (error) {
    console.error('Export error:', error);
    showStatusMessage('An error occurred during export. Please try again.', 'error');
  }
}

// SVG export functionality removed

// Utility functions
function rgbToHex(rgb) {
  if (rgb.startsWith('#')) return rgb;
  
  const values = rgb.match(/\d+/g);
  if (!values || values.length < 3) return '#000000';
  
  const hex = values.slice(0, 3).map(val => {
    const hexVal = parseInt(val).toString(16);
    return hexVal.length === 1 ? '0' + hexVal : hexVal;
  }).join('');
  
  return '#' + hex;
}

function escapeXml(text) {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function selectAllText(element) {
  if (window.getSelection && document.createRange) {
    const range = document.createRange();
    range.selectNodeContents(element);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
  }
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function handleWindowResize() {
  // Adjust canvas size on window resize if needed
  const canvas = document.getElementById('canvas');
  if (window.innerWidth < 768) {
    canvas.style.width = '100%';
    canvas.style.height = '300px';
  }
}

function showStatusMessage(message, type = 'success') {
  const statusEl = document.getElementById('statusMessage');
  statusEl.textContent = message;
  statusEl.className = `status-message ${type} show`;
  
  setTimeout(() => {
    statusEl.classList.remove('show');
  }, 3000);
}

// Initialize on load
window.addEventListener('load', function() {
  showStatusMessage('Moodies Editor loaded successfully!', 'success');
});
// 3D Effect Functions
function detect3DEffect(textLayer) {
  const transform = textLayer.style.transform || '';
  
  if (transform.includes('rotateX') && transform.includes('rotateY') && transform.includes('skew')) {
    return 'isometric';
  } else if (transform.includes('perspective')) {
    return 'perspective';
  } else if (transform.includes('rotateX')) {
    return 'rotateX';
  } else if (transform.includes('rotateY')) {
    return 'rotateY';
  }
  
  return 'none';
}

function apply3DEffect(effectType) {
  if (!selectedTextLayer) return;
  
  const rotation = document.getElementById('textRotation').value;
  let transform = `rotate(${rotation}deg)`;
  
  // Show/hide custom options based on effect type
  const customOptions = document.getElementById('3dCustomOptions');
  const rotateXControl = document.getElementById('rotateXControl');
  const rotateYControl = document.getElementById('rotateYControl');
  const perspectiveControl = document.getElementById('perspectiveControl');
  
  // Hide all controls by default
  customOptions.style.display = 'none';
  rotateXControl.style.display = 'none';
  rotateYControl.style.display = 'none';
  perspectiveControl.style.display = 'none';
  
  // Get values from sliders
  const rotateXValue = document.getElementById('rotateXValue').value;
  const rotateYValue = document.getElementById('rotateYValue').value;
  const perspectiveValue = document.getElementById('perspectiveValue').value;
  
  switch (effectType) {
    case 'isometric':
      customOptions.style.display = 'block';
      rotateXControl.style.display = 'block';
      rotateYControl.style.display = 'block';
      transform = `rotate(${rotation}deg) rotateX(${rotateXValue}deg) rotateY(${rotateYValue}deg) skew(0deg, 0deg)`;
      break;
    case 'perspective':
      customOptions.style.display = 'block';
      rotateXControl.style.display = 'block';
      perspectiveControl.style.display = 'block';
      transform = `rotate(${rotation}deg) perspective(${perspectiveValue}px) rotateX(${rotateXValue}deg)`;
      break;
    case 'rotateX':
      customOptions.style.display = 'block';
      rotateXControl.style.display = 'block';
      transform = `rotate(${rotation}deg) rotateX(${rotateXValue}deg)`;
      break;
    case 'rotateY':
      customOptions.style.display = 'block';
      rotateYControl.style.display = 'block';
      transform = `rotate(${rotation}deg) rotateY(${rotateYValue}deg)`;
      break;
    default:
      // Just use the basic rotation
      break;
  }
  
  selectedTextLayer.style.transform = transform;
  saveState();
}

// Image selection functionality removed

// Theme toggle functionality
// Theme toggle functionality completely removed

// Image position controls removed
</script>
<script src="drawTextLayers.js"></script>
</body>

</html>